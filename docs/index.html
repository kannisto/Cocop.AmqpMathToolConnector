<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cocop.AmqpMathToolConnector: Cocop.AmqpMathToolConnector v.2.0.0</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="cocop_doxy.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Cocop.AmqpMathToolConnector
   &#160;<span id="projectnumber">2.0.0</span>
   </div>
   <div id="projectbrief">API to connect math environment with AMQP</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Cocop.AmqpMathToolConnector v.2.0.0 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr/>
<div class="image">
<img src="logos.png" alt="COCOP and EU" style="display:block;margin-right:auto"/>
</div>
<p>COCOP - Coordinating Optimisation of Complex Industrial Processes <br />
<a href="https://cocop-spire.eu/">https://cocop-spire.eu/</a></p>
<p>This project has received funding from the European Union's Horizon 2020 research and innovation programme under grant agreement No 723661. This piece of software reflects only the authors' views, and the Commission is not responsible for any use that may be made of the information contained therein. </p><hr/>
<h2>Authors </h2>
<p>This application is based on the work of Sathish Kumar Narayanan <br />
<a href="https://github.com/ragavsathish/RabbitMQ-Matlab-Client/tree/master/src/mqwrapper">https://github.com/ragavsathish/RabbitMQ-Matlab-Client/tree/master/src/mqwrapper</a></p>
<p>The work of S. K. Narayanan is an implementation of: <br />
Yair Altman: Matlab callbacks for Java events <br />
30 Nov 2010 <br />
<a href="http://undocumentedmatlab.com/articles/matlab-callbacks-for-java-events">http://undocumentedmatlab.com/articles/matlab-callbacks-for-java-events</a></p>
<p>Modified and extended by Petri Kannisto, Tampere University, Finland <br />
<a href="https://github.com/kannisto">https://github.com/kannisto</a> <br />
<a href="http://kannisto.org">http://kannisto.org</a></p>
<p>Detailed author information:</p>
<ul>
<li>AmqpMathToolConnector<ul>
<li><a class="el" href="_notifier_8java.html">Notifier.java</a><ul>
<li>original work by S. K. Narayanan</li>
<li>modified by P. Kannisto</li>
</ul>
</li>
<li>All other classes: P. Kannisto</li>
</ul>
</li>
<li>AmqpMathToolConnectorTest: P. Kannisto</li>
<li>AmqpPropsManagerUnitTest: P. Kannisto</li>
</ul>
<p><b>Please make sure to read and understand <a href="./LICENSE.txt">LICENSE.txt</a>!</b></p>
<h2>COCOP Toolkit </h2>
<p>This application is a part of COCOP Toolkit, which was developed to enable a decoupled and well-scalable architecture in industrial systems. Please see <a href="https://kannisto.github.io/Cocop-Toolkit/">https://kannisto.github.io/Cocop-Toolkit/</a></p>
<h2>Introduction </h2>
<p>The purpose of this application is to connect an AMQP 0-9-1 message bus with a calculation environment. In particular, it was designed to connect Matlab with RabbitMQ.</p>
<p>This repository contains an entire Eclipse workspace. The included applications are as follows:</p>
<ul>
<li>AmqpMathToolConnector: the actual connector application</li>
<li>AmqpMathToolConnectorTest: console application to test connecting with the message bus</li>
<li>AmqpPropsManagerUnitTest: JUnit unit test for the AmqpPropsManager class</li>
</ul>
<p>See also:</p>
<ul>
<li>Github repo: <a href="https://github.com/kannisto/Cocop.AmqpMathToolConnector">https://github.com/kannisto/Cocop.AmqpMathToolConnector</a></li>
<li>API documentation: <a href="https://kannisto.github.io/Cocop.AmqpMathToolConnector">https://kannisto.github.io/Cocop.AmqpMathToolConnector</a></li>
</ul>
<h2>Environment and Libraries </h2>
<p>The development environment was <em>Eclipse Photon Release (4.8.0), Build id: 20180619-1200</em>.</p>
<p>For execution, the following should do it:</p>
<ul>
<li>Java: JDK/JRE 8 or newer</li>
<li>Matlab: 2017 or newer</li>
</ul>
<p>The following libraries were utilised in development:</p>
<ul>
<li>amqp-client-4.2.2.jar<ul>
<li>see <a href="https://www.rabbitmq.com/download.html">https://www.rabbitmq.com/download.html</a></li>
</ul>
</li>
<li>amqp-client-4.2.2-javadoc.jar</li>
<li>commons-logging-1.2.jar</li>
<li>slf4j-api-1.7.25.jar</li>
<li>slf4j-nop-1.7.25.jar</li>
</ul>
<h2>Known Limitations </h2>
<p>The software always assumes '/' as the vhost on AMQP server, which is the default. Therefore, you cannot presumably connect to CloudAMQP that forces you to use another vhost.</p>
<h2>Usage in Matlab</h2>
<p>To utilise the AMQP connector in Matlab, you can follow these instructions.</p>
<ul>
<li>If you are new to RabbitMQ, you should first try it without Matlab<ul>
<li>Matlab adds more difficulty to the first experiments</li>
<li>For tutorials, see <a href="https://www.rabbitmq.com/getstarted.html">https://www.rabbitmq.com/getstarted.html</a></li>
</ul>
</li>
<li>To debug your code, it is advisable to implement a simple publisher and subscriber in another environment</li>
</ul>
<p>Once you have established a connection, you communicate in Matlab as follows:</p>
<ul>
<li>To publish (or send) a message, you simply call the respective function</li>
<li>To receive messages<ul>
<li>you listen to one or more topics</li>
<li>you need at least one callback function<ul>
<li>AmqpMathToolConnector calls the callback in the background</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>The following figure illustrates the concepts and usage in Matlab.</p>
<div class="image">
<img src="amqpmathtoolconnector.png" alt="Matlab usage illustrated" style="display:block;margin-right:auto"/>
</div>
<h3>Adding JAR libraries to classpath</h3>
<p>Matlab must have an access to the required JAR libraries. Steps:</p>
<ol type="1">
<li>Retrieve "Cocop.AmqpMathToolConnector" as a JAR file<ul>
<li>this is available as a release in the Github page: <a href="https://github.com/kannisto/Cocop.AmqpMathToolConnector/releases">https://github.com/kannisto/Cocop.AmqpMathToolConnector/releases</a></li>
<li>alternatively, you can build your own JAR from source code</li>
</ul>
</li>
<li>Retrieve the following libraries as JAR files (it is unclear if the versions can be different):<ul>
<li>amqp-client-4.2.2.jar<ul>
<li>see <a href="https://www.rabbitmq.com/download.html">https://www.rabbitmq.com/download.html</a></li>
</ul>
</li>
<li>commons-logging-1.2.jar</li>
<li>slf4j-api-1.7.25.jar</li>
<li>slf4j-nop-1.7.25.jar</li>
</ul>
</li>
<li>Copy the JAR files to whatever folder you want to (such as 'C:\myclasspath')<ul>
<li>please avoid a filepath with spaces</li>
</ul>
</li>
<li>In your Matlab preferences folder, create a file called 'javaclasspath.txt'<ul>
<li>to locate this folder, use the 'prefdir' command<ul>
<li>see <a href="https://se.mathworks.com/help/matlab/ref/prefdir.html">https://se.mathworks.com/help/matlab/ref/prefdir.html</a></li>
</ul>
</li>
<li>in the classpath file, add the full path of each JAR file<ul>
<li>e.g., <code>C:\myclasspath\cocop_amqpmathtoolconnector.jar</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<h3>Creating callback for data reception</h3>
<p>To receive messages, you must create a callback function in Matlab. For instance:</p>
<div class="fragment"><div class="line">function myAmqpCallback(hObject, eventData)</div><div class="line"></div><div class="line">    % Routing key is the name of the respective topic in this example</div><div class="line"></div><div class="line">    routingKey = eventData.routingKey;</div><div class="line">    disp(&#39;Received a message with routing key:&#39;);</div><div class="line">    disp(routingKey);</div><div class="line"></div><div class="line">    if strcmp(routingKey, &#39;my.expected.routingkey&#39;)</div><div class="line"></div><div class="line">        messageAsByteArray = eventData.message;</div><div class="line">        % Do whatever you want with the message...</div><div class="line"></div><div class="line">    else</div><div class="line"></div><div class="line">        disp(&#39;Unexpected routing key!&#39;);</div><div class="line">        return;</div><div class="line"></div><div class="line">    end</div><div class="line"></div><div class="line">end</div></div><!-- fragment --><p>Steps:</p>
<ol type="1">
<li>Write your callback function in an M file, such as 'C:\myfunctions\mycallback.m'<ul>
<li>please avoid a filepath with spaces</li>
</ul>
</li>
<li>Add the folder containing the callback to the Matlab path<ul>
<li>in your personal MATLAB folder, add a file called 'startup.m'<ul>
<li>this folder is presumably 'C:\Users\(username)\Documents\MATLAB'</li>
</ul>
</li>
<li>in this file, use addpath to add the folder containing your M file<ul>
<li>e.g., <code>addpath('C:\myfunctions');</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<h3>Activating AMQP listeners</h3>
<p>The following code creates an object that will deliver notifications from the specified topic to the callback function "myAmqpCallback".</p>
<ul>
<li>You can listen to as many topics as needed<ul>
<li>you must specify all topics as a constructor parameters to AmqpConnector</li>
</ul>
</li>
<li>Replace the parameters ('myhost.com', etc.) with the ones relevant to you</li>
</ul>
<div class="fragment"><div class="line">% Specifying topics to listen to</div><div class="line">topicIn1 = &#39;topic.in.1&#39;;</div><div class="line">topicIn2 = &#39;topic.in.2&#39;;</div><div class="line"></div><div class="line">% Specify AMQP properties</div><div class="line">amqpProps = eu.cocop.amqp2math.AmqpPropsManager(&#39;myhost.com&#39;, &#39;my.exchange&#39;, &#39;user-x&#39;, &#39;my-password&#39;);</div><div class="line"></div><div class="line">% If using a non-secure connection:</div><div class="line">amqpProps.setSecure(false);</div><div class="line"></div><div class="line">% Specify topics to listen to</div><div class="line">topicsIn = javaArray(&#39;java.lang.String&#39;, 2);</div><div class="line">topicsIn(1) = java.lang.String(topicIn1);</div><div class="line">topicsIn(2) = java.lang.String(topicIn2);</div><div class="line"></div><div class="line">% Set up AMQP connector</div><div class="line">amqpConnector = eu.cocop.amqp2math.AmqpConnector(amqpProps, topicsIn);</div><div class="line"></div><div class="line">% Associate a topic listener with Matlab</div><div class="line">notifier = amqpConnector.getNotifierForTopic(topicIn1);</div><div class="line">handleObj = handle(notifier, &#39;CallbackProperties&#39;);</div><div class="line">set(notifier, &#39;ListenCallback&#39;, @(handleObj, ev)myAmqpCallback(handleObj, ev));</div></div><!-- fragment --><h3>Publishing (sending) to AMQP</h3>
<p>The following code sends a string encoded in UTF-8.</p>
<div class="fragment"><div class="line">myStringOut = java.lang.String(&#39;Hello 5&#39;);</div><div class="line">myBytesOut = myStringOut.getBytes(java.nio.charset.Charset.forName(&#39;UTF-8&#39;));</div><div class="line">amqpConnector.sendMessage(&#39;my.topic.Out&#39;, myBytesOut);</div></div><!-- fragment --><h3>Cleanup</h3>
<p>It is important to clean up resources after use. Call this when you end execution:</p>
<div class="fragment"><div class="line">amqpConnector.close();</div></div><!-- fragment --> </div></div><!-- contents -->
<hr class="footer"/><address class="footer">
<div style="margin:0.5rem;padding:0.5rem;display:block;background-color:#f7f7f7;text-align:left;">
  <p style="font-size:0.9rem">Before using this software, please make sure to read and understand <a href="LICENSE.txt">LICENSE.txt</a>.</p>
</div>
<div style="margin:0.5rem;padding:0.5rem;display:block;text-align:left;">
  <img src="logos.png" alt="COCOP and EU" />
  <p style="font-size:0.75rem">COCOP - Coordinating Optimisation of Complex Industrial Processes<br />
  <a href="https://cocop-spire.eu/">https://cocop-spire.eu/</a></p>
  <p style="font-size:0.75rem">This project has received funding from the European Union's Horizon 2020 research and innovation programme under grant agreement No 723661. This piece of software reflects only the authors' views, and the Commission is not responsible for any use that may be made of the information contained therein.</p>
</div>
<small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a>
</small></address>
